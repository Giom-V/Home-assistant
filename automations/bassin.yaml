# Automations related to the pond's pump.
#
# There are 5 automations:
# * `Turn on the pond's pump during off-peak hours`: Turns on the pump when
#   off-peak hours start, but only if the temperature is above 0°C.
# * `Turn off the pond's pump during peak hours`: Turns off the pump when
#   peak hours start, or at 2 PM.
# * `Turn off water pump when it's freezing`: Turns off the pump if the
#   temperature is below 0°C for 5 minutes.
# * `Turn on pond's pump when we are here during lunch time`: Turns on the
#   pump at noon if someone is at home or if there are visitors.
# * `Turn on water pump for 5mn to scare animals`: If the presence sensor
#   detects something for 10s, and if we are not in a "red" day for electricity
#   and the gate is closed, then turn on the pump for 5 minutes. If we are in
#   peak hours, turn it off after 5 minutes.

- id: pond_pump_on_off_peak
  alias: Turn on the pond's pump during off-peak hours
  description: Turns on the pump when off-peak hours start, if not freezing.
  triggers:
    - platform: state
      entity_id: binary_sensor.heure_creuse
      to: "on"
  conditions:
    - condition: numeric_state
      entity_id: sensor.module_exterieur_netatmo_temperature
      above: 0
  actions:
    - service: switch.turn_on
      target:
        entity_id: switch.fontaine_bassin
  mode: single
- id: pond_pump_off_peak
  alias: Turn off the pond's pump during peak hours
  description: Turns off the pump when peak hours start, or at 2 PM.
  triggers:
    - platform: state
      entity_id: binary_sensor.heure_creuse
      to: "off"
    - platform: time
      at: "14:00:00"
  conditions:
    - condition: state
      entity_id: binary_sensor.heure_creuse
      state: "off"
  actions:
    - service: switch.turn_off
      target:
        entity_id: switch.fontaine_bassin
  mode: single
- id: pond_pump_off_freezing
  alias: Turn off water pump when it's freezing
  description: Turns off the pump if the temperature drops below 0°C for 5 minutes.
  triggers:
    - platform: numeric_state
      entity_id: sensor.module_exterieur_netatmo_temperature
      below: 0
      for:
        minutes: 5
  conditions: []
  actions:
    - service: switch.turn_off
      target:
        entity_id: switch.fontaine_bassin
  mode: single
- id: pond_pump_on_lunchtime
  alias: Turn on pond's pump when we are here during lunch time
  description: Turns on the pump at noon if someone is home or visiting.
  triggers:
    - platform: time
      at: "12:00:00"
  conditions:
    - condition: or
      conditions:
        - condition: state
          entity_id: input_boolean.visitors
          state: "on"
        - condition: state
          entity_id: binary_sensor.people_home
          state: "on"
  actions:
    - service: switch.turn_on
      target:
        entity_id: switch.fontaine_bassin
  mode: single
- id: pond_pump_scare_animals
  alias: Turn on water pump for 5mn to scare animals
  description: Turns on the pump for 5 minutes to scare animals if presence is detected.
  triggers:
    - platform: state
      entity_id: binary_sensor.terrasse_animal
      to: "on"
      for:
        seconds: 10
  conditions:
    - condition: not
      conditions:
        - condition: state
          entity_id: sensor.rte_tempo_couleur_actuelle
          state: Rouge
    - condition: state
      entity_id: binary_sensor.terrasse_person
      state: "off"
  actions:
    - service: switch.turn_on
      target:
        entity_id: switch.fontaine_bassin
    - delay:
        minutes: 5
    - if:
        - condition: state
          entity_id: binary_sensor.heure_creuse
          state: "off"
      then:
        - service: switch.turn_off
          target:
            entity_id: switch.fontaine_bassin
  mode: restart
